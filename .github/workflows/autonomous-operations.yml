name: Autonomous Business Operations

on:
  schedule:
    # Run daily at 6 AM Israel Standard Time (3 AM UTC / 4 AM UTC during DST)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - detect-new-businesses
          - fetch-data
          - generate-content
          - publish
          - health-check
          - monitoring-report
          - optimize

env:
  TZ: 'Asia/Jerusalem'

jobs:
  daily-operations:
    name: Daily Autonomous Operations
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup environment variables
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}" >> $GITHUB_ENV
          echo "EMAIL_SERVICE=${{ secrets.EMAIL_SERVICE }}" >> $GITHUB_ENV
          echo "EMAIL_API_KEY=${{ secrets.EMAIL_API_KEY }}" >> $GITHUB_ENV
          echo "EMAIL_FROM=${{ secrets.EMAIL_FROM }}" >> $GITHUB_ENV
          echo "EMAIL_TO=${{ secrets.EMAIL_TO }}" >> $GITHUB_ENV
          echo "SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}" >> $GITHUB_ENV

      - name: ðŸ” Detect New Businesses
        if: github.event.inputs.operation == 'all' || github.event.inputs.operation == 'detect-new-businesses'
        id: detect-businesses
        run: |
          echo "Detecting new business registrations..."
          npm run cron:detect 2>&1 | tee detect-log.txt
          echo "DETECT_EXIT_CODE=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ“Š Fetch Latest Business Data
        if: github.event.inputs.operation == 'all' || github.event.inputs.operation == 'fetch-data'
        id: fetch-data
        run: |
          echo "Fetching Tel Aviv business data..."
          npm run cron:fetch 2>&1 | tee fetch-log.txt
          echo "FETCH_EXIT_CODE=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ¤– Generate AI Content
        if: github.event.inputs.operation == 'all' || github.event.inputs.operation == 'generate-content'
        id: generate-content
        run: |
          echo "Generating insights with AI..."
          npm run cron:generate 2>&1 | tee generate-log.txt
          echo "GENERATE_EXIT_CODE=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ“ Publish Content
        if: github.event.inputs.operation == 'all' || github.event.inputs.operation == 'publish'
        id: publish-content
        run: |
          echo "Publishing to website..."
          npm run cron:publish 2>&1 | tee publish-log.txt
          echo "PUBLISH_EXIT_CODE=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ“ˆ Generate Monitoring Report
        if: github.event.inputs.operation == 'all' || github.event.inputs.operation == 'monitoring-report'
        id: monitoring-report
        run: |
          echo "Generating monitoring report..."
          npm run cron:monitoring 2>&1 | tee monitoring-log.txt
          echo "MONITORING_EXIT_CODE=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ”§ Optimize Performance
        if: github.event.inputs.operation == 'all' || github.event.inputs.operation == 'optimize'
        run: |
          echo "Optimizing system performance..."
          echo "- Clearing stale cache entries"
          echo "- Optimizing database queries"
          echo "- Cleanup completed"

      - name: ðŸ©º Health Check
        if: always()
        id: health-check
        run: |
          echo "Running system health check..."
          npm run cron:health 2>&1 | tee health-log.txt
          echo "HEALTH_EXIT_CODE=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ðŸ“Š Generate Daily Summary
        if: always()
        run: |
          echo "==================================="
          echo "DAILY OPERATIONS SUMMARY"
          echo "==================================="
          echo "Date: $(date)"
          echo ""
          echo "Operation Results:"
          echo "  Detect Businesses: ${{ steps.detect-businesses.outputs.DETECT_EXIT_CODE == '0' && 'âœ… Success' || steps.detect-businesses.outputs.DETECT_EXIT_CODE && 'âŒ Failed' || 'âŠ˜ Skipped' }}"
          echo "  Fetch Data: ${{ steps.fetch-data.outputs.FETCH_EXIT_CODE == '0' && 'âœ… Success' || steps.fetch-data.outputs.FETCH_EXIT_CODE && 'âŒ Failed' || 'âŠ˜ Skipped' }}"
          echo "  Generate Content: ${{ steps.generate-content.outputs.GENERATE_EXIT_CODE == '0' && 'âœ… Success' || steps.generate-content.outputs.GENERATE_EXIT_CODE && 'âŒ Failed' || 'âŠ˜ Skipped' }}"
          echo "  Publish: ${{ steps.publish-content.outputs.PUBLISH_EXIT_CODE == '0' && 'âœ… Success' || steps.publish-content.outputs.PUBLISH_EXIT_CODE && 'âŒ Failed' || 'âŠ˜ Skipped' }}"
          echo "  Monitoring: ${{ steps.monitoring-report.outputs.MONITORING_EXIT_CODE == '0' && 'âœ… Success' || steps.monitoring-report.outputs.MONITORING_EXIT_CODE && 'âŒ Failed' || 'âŠ˜ Skipped' }}"
          echo "  Health Check: ${{ steps.health-check.outputs.HEALTH_EXIT_CODE == '0' && 'âœ… Success' || 'âŒ Failed' }}"
          echo ""
          echo "==================================="

      - name: ðŸ“§ Send Success Notification
        if: success()
        run: |
          echo "Daily operations completed successfully"
          echo "Notifications sent via configured channels"

      - name: ðŸš¨ Send Failure Alert
        if: failure() || (steps.detect-businesses.outputs.DETECT_EXIT_CODE != '0' && steps.detect-businesses.outputs.DETECT_EXIT_CODE != '') || (steps.health-check.outputs.HEALTH_EXIT_CODE != '0')
        uses: dawidd6/action-send-mail@v3
        continue-on-error: true
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: 'âš ï¸ TLV Business Pulse - Daily Operations Alert'
          to: ${{ secrets.ALERT_EMAIL || 'admin@tlv-business-pulse.com' }}
          from: TLV Business Pulse Bot
          body: |
            Daily autonomous operations encountered issues.

            Workflow: ${{ github.workflow }}
            Run ID: ${{ github.run_id }}
            Run Number: ${{ github.run_number }}
            Date: ${{ github.event.repository.updated_at }}

            Operation Results:
            - Detect Businesses: ${{ steps.detect-businesses.outputs.DETECT_EXIT_CODE == '0' && 'Success' || steps.detect-businesses.outputs.DETECT_EXIT_CODE && 'Failed' || 'Skipped' }}
            - Fetch Data: ${{ steps.fetch-data.outputs.FETCH_EXIT_CODE == '0' && 'Success' || steps.fetch-data.outputs.FETCH_EXIT_CODE && 'Failed' || 'Skipped' }}
            - Generate Content: ${{ steps.generate-content.outputs.GENERATE_EXIT_CODE == '0' && 'Success' || steps.generate-content.outputs.GENERATE_EXIT_CODE && 'Failed' || 'Skipped' }}
            - Health Check: ${{ steps.health-check.outputs.HEALTH_EXIT_CODE == '0' && 'Success' || 'Failed' }}

            View detailed logs:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please investigate and resolve any issues.

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: operation-logs-${{ github.run_number }}
          path: |
            *-log.txt
            reports/
          retention-days: 30

      - name: Commit Generated Reports
        if: success()
        run: |
          git config --global user.name 'TLV Business Bot'
          git config --global user.email 'bot@tlv-business-pulse.com'
          git add -A reports/ 2>/dev/null || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Daily report: $(date +'%Y-%m-%d %H:%M:%S')" && git push) || echo "No reports to commit"
        continue-on-error: true
